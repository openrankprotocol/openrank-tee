#!/usr/bin/env bash

set -e

source "$( dirname "${BASH_SOURCE[0]}" )/helpers/helpers.sh"

log "Running TEE AVS template tests..."

# Check if required tools are available
ensureForge
ensureDocker

# Test contracts if they exist
if [ -d "contracts" ] && [ -f "contracts/foundry.toml" ]; then
    log "Running contract tests..."
    (cd contracts && forge test && cd -) >&2
    log "Contract tests completed successfully."
else
    log "No contracts directory found, skipping contract tests."
fi

# Test Docker Compose validation
log "Testing Docker Compose configuration..."
if [ ! -f "docker-compose.yml" ]; then
    log "Error: docker-compose.yml not found!"
    exit 1
fi

# Validate docker-compose file syntax
docker compose config > /dev/null 2>&1 || {
    log "Error: Invalid docker-compose.yml file!"
    exit 1
}
log "Docker Compose validation passed."

# Test environment file processing
log "Testing environment file processing..."
if [ -f ".env.public" ]; then
    log "Found .env.public - OK"
else
    log "No .env.public found (optional)"
fi

if [ -f ".env.private" ]; then
    log "Found .env.private - OK. Verifying encryption..."

    TEST_RECIPIENT="age102rz055sfxf9e0aqndzws9ekl8cum0lzd4x25k6u7qgjrrdpfdmqe6zcd4"
    TEST_SECRET_KEY="AGE-SECRET-KEY-1XLXNRJSV2D0977YQ4CV080XYMF3Y6Y6FSXQL0TEWZNSD0L552L5Q60XT6Z"

    age -r "$TEST_RECIPIENT" -o .env.private.encrypted .env.private
    age -d -i <(echo "$TEST_SECRET_KEY") .env.private.encrypted
    rm .env.private.encrypted

    log "Encryption verification passed."
else
    log "No .env.private found (optional)"
fi

log "All TEE AVS template tests passed successfully!"
